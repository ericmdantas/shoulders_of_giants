"use strict";!function(){angular.module("emd.client.socket.module",["btford.socket-io"]).service("SocketService",["socketFactory",function(a){return a()}])}();var quotesApp=angular.module("quotes",["ngResource","btford.socket-io","emd.client.socket.module","emd.ng-xtorage"]);quotesApp.config(["$xtorageProvider",function(a){a.storage="sessionStorage",a.storageExpiration=216e5}]),quotesApp.constant("author",{name:"Eric Mendes Dantas",github:"https://github.com/ericmdantas"}),quotesApp.controller("QuotesController",["$rootScope","$scope","QuotesModel","QuotesDAO","SocketService","Randomizer","$timeout",function(a,b,c,d,e,f,g){b.quotes=[],b.quotesKeeper=[],b.errorQuoteCreation=null,b.favQuote=d.favQuote,b.quoteInstance=new c;var h=function(){var c=function(c){b.quotes=c,b.quotesKeeper=angular.copy(b.quotes),g(function(){a.$broadcast("quotes-ready")},2e3)};d.getAll().then(c)};e.on("quote:faved",function(a){for(var c=0;c<b.quotes.length;c++)if(a===b.quotes[c]._id){b.quotes[c].likes+=1;break}}),b.setOrder=function(a){if(!angular.isString(a))throw new Error("Ordenação incorreta. O tipo do parâmetro deve ser uma string.");b.getOrder=a},b.createQuote=function(a){var e=function(a){b.errorQuoteCreation=null,b.quoteInstance=new c,b.quotes.push(a)},f=function(a){b.errorQuoteCreation=a.msg};d.createQuote(a).then(e,f)},b.setSingle=function(a){if(!angular.isArray(a))throw new Error("Houve um erro ao randomizar as mensagens. O objeto passado não é um objeto ou array válido.");var c=a.length,d=Math.floor(Math.random()*c);b.quotes=[a[d]],b.singleView=!0},b.setMultiple=function(){b.singleView=!1,b.quotes=b.quotesKeeper},b.randomize=function(){b.quotes=f.shuffleSingle(b.quotesKeeper)},b.setOrder("author"),h()}]),quotesApp.directive("activable",[function(){return function(a,b,c){b.on("click",function(){var a=c.deactive||null;if(!angular.isString(a))throw new Error("É necessário informar o caminho do element a ser removido a classe active.");$(a).removeClass("active"),b.addClass("active")})}}]),quotesApp.directive("emdOptionsNavigation",["$timeout",function(a){var b="partials/includes/options-navigation.html",c=["$scope","Randomizer",function(a,b){a.modalOptions={titulo:null,conteudo:[]},a.onViewClick=function(){a.modalOptions={titulo:"View",conteudo:[{nome:"Single",onClick:function(){a.setSingle(a.quotes)}},{nome:"Multiple",onClick:a.setMultiple}]}},a.onOrderByClick=function(){a.modalOptions={titulo:"Order By",conteudo:[{nome:"Quote",onClick:function(){a.getOrder="quotes"}},{nome:"Author",onClick:function(){a.getOrder="author"}},{nome:"Most liked",onClick:function(){a.getOrder="-likes"}}]}},a.onShuffleClick=function(){a.getOrder=null,b.shuffle(a.quotes)}}],d=function(b){b.$watch("modalOptions",function(){a(function(){switch(b.modalOptions.conteudo.length){case 2:$(".modal-body .btn-group .btn").addClass("col-xs-6");break;case 3:$(".modal-body .btn-group .btn").addClass("col-xs-4")}},3)})};return{restrict:"E",templateUrl:b,controller:c,link:d}}]),quotesApp.directive("showModalWhenNoQuotes",["$rootScope",function(a){var b="partials/includes/modal-loading.html",c=function(){var b="#modal-loading-quotes",c=function(){$(b).modal("show")},d=function(){var c=a.$on("quotes-ready",function(){$(b).modal("hide"),c()})};return{pre:c,post:d}},d={};return{restrict:"E",templateUrl:b,compile:c,scope:d}}]),quotesApp.directive("like",[function(){var a="partials/includes/likes.html",b=function(a,b){a.star="fa-star-o",b.on("click",function(){a.star="fa-star"})};return{restrict:"E",templateUrl:a,link:b,scope:{liked:"&",numberlikes:"@"}}}]),quotesApp.directive("showOtherOptions",[function(){var a=function(a,b){b.on("click",function(){$(".opt").not(b).slideToggle(),b.find(".fa").toggleClass("fa-minus")})};return a}]),quotesApp.factory("QuotesModel",[function(){function a(a){this.author=null,this.quote=null,this.likes=0,angular.extend(this,a)}return a.prototype={isValid:function(){return angular.isString(this.author)&&angular.isString(this.quote)},removeQuotationMarks:function(){var a=this.quote,b=/^"|^'|"$|'$/g;return a=a.replace(b,"")}},a}]),quotesApp.factory("QuotesResource",["$resource",function(a){var b="/api/quotes/:type/:id",c={id:"@id"},d={update:{method:"PUT"}};return a(b,c,d)}]),quotesApp.service("QuotesCache",["$xtorage",function(a){var b="q",c=function(c){if(!angular.isArray(c))throw new Error("A informação a ser armazenada em cache deve ser um array.");a.save(b,c)},d=function(){return a.get(b)};this.saveArray=c,this.getArray=d}]),quotesApp.service("QuotesDAO",["$q","SocketService","QuotesModel","QuotesCache","QuotesResource",function(a,b,c,d,e){var f=function(){var b=a.defer(),f=d.getArray();if(f)return a.when(f);var g=function(a){var e=[];angular.forEach(a,function(a){e.push(new c(a))}),d.saveArray(e),b.resolve(e)};return e.query().$promise.then(g),b.promise},g=function(a){if(!angular.isString(a))throw new Error("O id passado não é uma string válida. Não será possível favoritar a mensagem.");b.emit("fav:quote",a)},h=function(b){var d=a.defer(),f=function(a){var b=new c(a);d.resolve(b)},g=function(a){var b={msg:a.data.error,status:a.status};d.reject(b)};return angular.isObject(b)&&b instanceof c&&b.isValid()?(b.quote=b.removeQuotationMarks(),e.save(b).$promise.then(f,g),d.promise):(d.reject(new Error("Não é possível criar uma nova frase, pois a mesma não é válida.")),d.promise)};this.getAll=f,this.favQuote=g,this.createQuote=h}]),quotesApp.service("Randomizer",[function(){var a=function(a){for(var b,c,d=a.length;d;)c=Math.floor(Math.random()*d--),b=a[d],a[d]=a[c],a[c]=b;return a},b=function(a){var b=a.length,c=Math.floor(Math.random()*b);return[a[c]]};this.shuffle=a,this.shuffleSingle=b}]);